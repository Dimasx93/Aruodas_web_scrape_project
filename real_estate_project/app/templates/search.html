{% extends "base.html" %}
{% block title %}Property Search{% endblock %}

{% block content %}
<h2>Search Properties</h2>

<!-- Include Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<form method="POST">
    {{ form.hidden_tag() }}

    <label for="city">City:</label>
    <select id="city" name="city" style="width: 100%;"></select>

    <label for="district">District:</label>
    <select id="district" name="district" style="width: 100%;"></select>

    {{ form.price_min.label }} {{ form.price_min }}<br>
    {{ form.price_max.label }} {{ form.price_max }}<br>
    {{ form.size_min.label }} {{ form.size_min }}<br>
    {{ form.size_max.label }} {{ form.size_max }}<br>
    {{ form.price_m2_min.label }} {{ form.price_m2_min }}<br>
    {{ form.price_m2_max.label }} {{ form.price_m2_max }}<br>
    {{ form.number_of_rooms.label }} {{ form.number_of_rooms }}<br>
    {{ form.submit }}
</form>

<!-- Save Search UI -->
<hr>
<h3>Save This Search</h3>
<label for="searchName">Search Name:</label>
<input type="text" id="searchName" placeholder="e.g. Cheap in Vilnius">
<button id="saveSearchBtn">Save Search</button>

<!-- Analyze Median -->
<hr>
<h3>Analyze Medium value</h3>
<form method="POST" action="{{ url_for('analyze_selected_median') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <label for="field">Select field for median:</label>
    <select name="field" id="field">
        <option value="price">Price (€)</option>
        <option value="size_m2">Size (m²)</option>
        <option value="price_per_m2">Price per m² (€)</option>
        <option value="number_of_rooms">Number of Rooms</option>
    </select>
    <button type="submit">Show Result</button>
</form>

<!-- Show Results -->
{% if results %}
<h3>Results:</h3>
<ul>
    {% for prop in results %}
    <li>
        {{ prop.city }}, {{ prop.district }} - {{ prop.price }} € -
        {{ prop.size_m2 }} m² - {{ prop.number_of_rooms }} rooms -
        {{ prop.price_per_m2 }} €/m² <br>
        <a href="{{ prop.url }}" target="_blank">View advertisement</a>
    </li>
    {% endfor %}
</ul>
{% endif %}

<!-- JavaScript -->
<script>
$(document).ready(function() {
    $('#city').select2({
        placeholder: 'Select a city',
        ajax: {
            url: '/autocomplete/city',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return {
                    results: data.map(function (item) {
                        return { id: item, text: item };
                    })
                };
            }
        }
    });

    $('#district').select2({
        placeholder: 'Select a district',
        ajax: {
            url: '/autocomplete/district',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term,
                    city: $('#city').val()
                };
            },
            processResults: function (data) {
                return {
                    results: data.map(function (item) {
                        return { id: item, text: item };
                    })
                };
            }
        }
    });

    // Reset district when city changes
    $('#city').on('change', function () {
        $('#district').val(null).trigger('change');
    });

    // Save search
    document.getElementById("saveSearchBtn").addEventListener("click", function () {
        const name = document.getElementById("searchName").value;
        const query = {{ query | tojson | safe }};
        if (!name) {
            alert("Please provide a name for the search.");
            return;
        }
        fetch("/save_search", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ name: name, query: query })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || "Search saved!");
        })
        .catch(error => {
            alert("Error saving search.");
            console.error(error);
        });
    });
});
</script>

{% endblock %}
